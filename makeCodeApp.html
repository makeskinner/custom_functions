<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Make.com JS Function Generator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .custom-loader {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: 
                radial-gradient(farthest-side,#474bff 94%,#0000) top/8px 8px no-repeat,
                conic-gradient(#0000 30%,#474bff);
            -webkit-mask: radial-gradient(farthest-side,#0000 calc(100% - 8px),#000 0);
            animation:c3 1s infinite linear;
        }
        @keyframes c3 {
            100%{transform: rotate(1turn)}
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-800">
    <div class="container mx-auto p-4 md:p-8 max-w-4xl">

        <header class="text-center mb-8">
            <h1 class="text-4xl font-bold text-gray-900">Make.com Function Generator</h1>
            <p class="text-lg text-gray-600 mt-2">Create JavaScript functions for the Make.com 'Code' module, guaranteed to follow the required structure.</p>
        </header>

        <main class="bg-white p-6 rounded-2xl shadow-lg border border-gray-200">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <!-- Left Column: Instructions and Input -->
                <div class="flex flex-col space-y-4">
                    <div>
                        <h2 class="text-xl font-semibold text-gray-800">1. Describe Your Function</h2>
                        <p class="text-gray-500 mt-1">In plain English, describe what you want the function to do. Mention any input variables you'll be using.</p>
                        <textarea id="userInput" class="mt-2 w-full h-48 p-3 bg-gray-50 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-shadow" placeholder="e.g., Take an input variable 'fullName' and split it into 'firstName' and 'lastName'. Also, take an 'email' variable and return it in lowercase."></textarea>
                    </div>
                     <button id="generateBtn" class="w-full bg-blue-600 text-white font-semibold py-3 px-4 rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-4 focus:ring-blue-300 transition-all shadow-md">
                        Generate Function
                    </button>
                    <div id="loader" class="hidden mx-auto">
                        <div class="custom-loader"></div>
                        <p class="text-center text-gray-500 mt-2">Generating...</p>
                    </div>
                </div>

                <!-- Right Column: Generated Code -->
                <div class="flex flex-col">
                     <h2 class="text-xl font-semibold text-gray-800">2. Get Your Code</h2>
                     <p class="text-gray-500 mt-1">Copy the generated code and paste it directly into a Make.com 'Code' module.</p>
                    <div class="relative mt-2 flex-grow">
                        <pre id="codeOutputWrapper" class="h-full bg-gray-900 text-white p-4 rounded-lg overflow-auto w-full language-javascript hidden"><code id="codeOutput"></code></pre>
                        <div id="placeholder" class="h-full flex items-center justify-center bg-gray-100 border-2 border-dashed border-gray-300 rounded-lg">
                            <p class="text-gray-500">Your generated code will appear here</p>
                        </div>
                        <button id="copyBtn" class="hidden absolute top-2 right-2 bg-gray-700 text-gray-300 hover:bg-gray-600 hover:text-white px-3 py-1 text-sm font-medium rounded-md transition-colors">
                            Copy
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Key Requirements Section -->
            <div class="mt-8 pt-6 border-t border-gray-200">
                <h3 class="text-2xl font-bold text-center text-gray-800 mb-4">Make.com 'Code' Module Requirements</h3>
                <ul class="space-y-3 text-gray-600 list-disc list-inside bg-slate-50 p-4 rounded-lg">
                    <li>The main function **must** be an `async` function named `run`.</li>
                    <li>Input data from other modules is accessed via the `inputData` object (e.g., `inputData.myVariable`).</li>
                    <li>The function **must** return an object (`{...}`) or an array of objects (`[{...}]`). Single values should be wrapped, e.g., `return { result: myValue }`.</li>
                    <li>External libraries (`require`/`import`) are **not allowed**. Only standard JavaScript APIs are available.</li>
                    <li>Use `console.log()` for debugging; the output appears in the module's log.</li>
                    <li>Handle errors gracefully with `try...catch` and throw new `Error('Your message')`.</li>
                </ul>
            </div>
        </main>
        
        <footer class="text-center mt-8 text-sm text-gray-500">
            <p>Generated with Gemini. Always test your code in Make.com before production use.</p>
        </footer>
    </div>

    <script>
        const generateBtn = document.getElementById('generateBtn');
        const userInput = document.getElementById('userInput');
        const codeOutput = document.getElementById('codeOutput');
        const codeOutputWrapper = document.getElementById('codeOutputWrapper');
        const placeholder = document.getElementById('placeholder');
        const copyBtn = document.getElementById('copyBtn');
        const loader = document.getElementById('loader');

        const systemPrompt = `
You are an expert JavaScript developer who specializes in writing code for the Make.com "Code" module.
Your task is to take a user's request and generate a single, complete JavaScript function that adheres to all Make.com requirements.

**STRICT REQUIREMENTS:**
1.  **Function Definition:** The code must contain a single \`async function run({ inputData })\`. Do not use any other function name or signature.
2.  **Input Data:** All input variables must be destructured from the \`inputData\` object. For example, if the user mentions a variable 'email', you must access it as \`inputData.email\`. Assume the user-mentioned variables exist on \`inputData\`.
3.  **Return Value:** The function MUST return a JavaScript object or an array of objects. If the user asks to return a single value, wrap it in an object (e.g., \`return { result: myValue };\`).
4.  **No External Libraries:** You MUST NOT use \`require()\` or \`import\`. Only use standard, built-in JavaScript APIs and features available in a modern Node.js environment.
5.  **Error Handling:** The entire logic inside the function must be wrapped in a \`try...catch\` block. In the catch block, re-throw the error to ensure it's properly logged by Make.com: \`throw new Error(error.message);\`.
6.  **Asynchronous Nature:** The function must always be \`async\`, even if it contains no asynchronous operations.
7.  **Comments:** Provide clear JSDoc comments explaining what the function does, its parameters (\`@param {object} inputData\`), and what it returns (\`@returns {Promise<object|object[]>}\`).
8.  **Code Only:** Your response must be ONLY the JavaScript code, enclosed in a single markdown block. Do not add any explanatory text before or after the code block.

**Example User Request:** "Get a name and an age. Return them in an object, but add a greeting."

**Example Correct Output:**
\`\`\`javascript
/**
 * Creates a greeting using a name and age from input.
 * @param {object} inputData - The input data from the Make.com module.
 * @param {string} inputData.name - The name to include in the greeting.
 * @param {number} inputData.age - The age of the person.
 * @returns {Promise<object>} An object containing the greeting message.
 */
async function run({ inputData }) {
  try {
    // Destructure variables for easier access and validation
    const { name, age } = inputData;

    if (!name || !age) {
      throw new Error('Both "name" and "age" must be provided.');
    }

    const greeting = \`Hello, \${name}! You are \${age} years old.\`;

    // Log for debugging in Make.com
    console.log('Successfully generated greeting.');

    // Return an object as required by Make.com
    return {
      message: greeting
    };

  } catch (error) {
    console.error('Error in function:', error.message);
    throw new Error(error.message);
  }
}
\`\`\`
`;

        generateBtn.addEventListener('click', async () => {
            const userQuery = userInput.value.trim();
            if (!userQuery) {
                alert('Please describe the function you want to create.');
                return;
            }

            // UI updates for loading state
            generateBtn.disabled = true;
            generateBtn.classList.add('opacity-50', 'cursor-not-allowed');
            loader.classList.remove('hidden');
            placeholder.classList.add('hidden');
            codeOutputWrapper.classList.add('hidden');
            copyBtn.classList.add('hidden');

            try {
                const apiKey = ""; // Canvas will provide the key
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;

                const payload = {
                    contents: [{ parts: [{ text: userQuery }] }],
                    systemInstruction: {
                        parts: [{ text: systemPrompt }]
                    },
                };

                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                
                if (!response.ok) {
                    throw new Error(`API Error: ${response.status} ${response.statusText}`);
                }

                const result = await response.json();
                let generatedCode = result.candidates?.[0]?.content?.parts?.[0]?.text || '// Sorry, could not generate the function.';
                
                // Clean the response to get only the code
                const codeBlockRegex = /```javascript\s*([\s\S]*?)\s*```/;
                const match = generatedCode.match(codeBlockRegex);
                if (match && match[1]) {
                    generatedCode = match[1].trim();
                }

                codeOutput.textContent = generatedCode;

                // Show the output
                codeOutputWrapper.classList.remove('hidden');
                copyBtn.classList.remove('hidden');

            } catch (error) {
                console.error('Generation failed:', error);
                placeholder.classList.remove('hidden');
                placeholder.innerHTML = `<p class="text-red-500 p-4">Error: Could not generate function. Please check the console for details.</p>`;
            } finally {
                // Restore UI
                generateBtn.disabled = false;
                generateBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                loader.classList.add('hidden');
            }
        });

        copyBtn.addEventListener('click', () => {
            if (navigator.clipboard) {
                 navigator.clipboard.writeText(codeOutput.textContent).then(() => {
                    copyBtn.textContent = 'Copied!';
                    setTimeout(() => {
                        copyBtn.textContent = 'Copy';
                    }, 2000);
                });
            } else {
                // Fallback for older browsers
                const textArea = document.createElement('textarea');
                textArea.value = codeOutput.textContent;
                document.body.appendChild(textArea);
                textArea.select();
                try {
                    document.execCommand('copy');
                    copyBtn.textContent = 'Copied!';
                    setTimeout(() => {
                        copyBtn.textContent = 'Copy';
                    }, 2000);
                } catch (err) {
                    console.error('Fallback copy failed', err);
                }
                document.body.removeChild(textArea);
            }
        });

    </script>
</body>
</html>
